---
import Layout from "@/layouts/Layout.astro";
import { i18nKeys } from "@/lib/i18n-runtime";
import { Masonry } from "astro-masonry";
import { getCollection } from "astro:content";
import { marked } from "marked";
const methods = await getCollection("methods");
const methodsCommunities = methods
	.reduce((acc, curr) => {
		const communities = curr.data?.community || [];
		return [...new Set([...acc, ...communities])];
	}, [])
	.sort((a, b) => a.localeCompare(b));
---

<Layout
	title="Методы шагов"
	description={`Методы 12 шагов: воркбуки, группы и практики для прохождения программы. ${methods.length} методов.`}
	titleKey={i18nKeys.methods.title}
	descriptionKey={i18nKeys.methods.description}
>
	<section class="flex flex-col gap-4" data-filter>
		<div class="flex flex-col gap-2 text-center">
			<p class="text-sm text-[color:var(--muted)]" data-i18n="methods.filterHint">
				Выберите сообщество или введите слово — список обновится автоматически.
			</p>
		</div>
		<div class="flex flex-wrap gap-2 justify-center items-center">
			<input
				type="search"
				placeholder="Поиск по названию и описанию"
				aria-label="Поиск по методам"
				data-i18n-placeholder="methods.searchPlaceholder"
				data-i18n-aria-label="methods.searchAria"
				class="w-full md:w-96 px-4 py-2 rounded-lg border border-[color:var(--border)] bg-[color:var(--surface)] shadow-2xs focus:outline-none focus:ring-2 focus:ring-black/10"
				data-search
			/>
			<button
				type="button"
				class="reset-button text-sm cursor-pointer px-3 py-2 rounded-lg shadow-2xs text-[color:var(--muted)] border border-[color:var(--border)] bg-[color:var(--surface)]"
				data-i18n="common.reset"
			>
				Сбросить
			</button>
		</div>
		<div class="flex justify-center flex-wrap gap-2 items-center">
			{
				methodsCommunities.map((item) => (
					<button
						class="filter-button cursor-pointer px-3 py-1.5 rounded-lg shadow-2xs bg-[color:var(--surface)] border border-[color:var(--border)]"
						type="button"
					>
						{item}
					</button>
				))
			}
		</div>
		<div class="text-center text-sm text-[color:var(--muted)]">
			<span data-i18n="common.foundLabel">Найдено:</span> <span data-count>0</span>
		</div>
	</section>
	<section class="relative -m-3 w-screen left-1/2 right-1/2 -ml-[50vw] -mr-[50vw]">
		<Masonry
			breakpointCols={{
				default: 4,
				1100: 3,
				700: 2,
				500: 1,
			}}
		>
			{
				methods &&
					methods.map((item) => (
						<article
							class="m-1 border border-[color:var(--border)] bg-[color:var(--surface)] relative flex rounded-xl flex-col gap-3"
							data-method-card
							data-community={item.data.community?.join(",") ?? ""}
						>
							<div class="flex flex-col rounded-xl shadow-2xs gap-2 p-6">
								<h2 class="leading-tight text-2xl md:text-3xl font-bold">{item.data.title}</h2>
								<p class="text-sm text-[color:var(--muted)] line-clamp-3">
									{item.data.description}
								</p>
							</div>
							<div class="p-6 border border-[color:var(--border)] rounded-xl prose max-w-none">
								<Fragment set:html={marked(item?.body)} />
							</div>
						</article>
					))
			}
		</Masonry>
	</section>

	<script is:inline>
		document.addEventListener("DOMContentLoaded", () => {
			const activedFilters = [];
			const filterElement = document.querySelector("[data-filter]");
			const searchInput = document.querySelector("[data-search]");
			const countElement = document.querySelector("[data-count]");

			function updateList() {
				const activedFiltersLower = activedFilters.map((item) =>
					item.toLowerCase().trim(),
				);
				const query = (searchInput?.value || "").toLowerCase().trim();
				let visibleCount = 0;

				filterElement
					?.querySelectorAll("button:not(.reset-button)")
					.forEach((button) => {
						const label = button.innerText.trim();
						if (activedFilters.includes(label)) {
							button.classList.add("active");
						} else {
							button.classList.remove("active");
						}
					});

				document.querySelectorAll("[data-method-card]").forEach((card) => {
					const communities = (card.dataset.community || "")
						.split(",")
						.map((item) => item.toLowerCase().trim());
					const text = (card.innerText || "").toLowerCase();

					if (
						(activedFiltersLower.length === 0 ||
							activedFiltersLower.some((item) => communities.includes(item))) &&
						(query.length === 0 || text.includes(query))
					) {
						card.classList.remove("hidden");
						visibleCount += 1;
					} else {
						card.classList.add("hidden");
					}
				});

				if (countElement) {
					countElement.textContent = String(visibleCount);
				}
			}

			filterElement?.addEventListener("click", (e) => {
				const target = e.target;
				if (target.tagName !== "BUTTON") return;

				if (target.classList.contains("reset-button")) {
					activedFilters.length = 0;
					if (searchInput) searchInput.value = "";
					updateList();
					return;
				}

				const label = target.innerText.trim();
				const index = activedFilters.indexOf(label);

				if (index > -1) {
					activedFilters.splice(index, 1);
				} else {
					activedFilters.push(label);
				}

				updateList();
			});

			searchInput?.addEventListener("input", () => {
				updateList();
			});

			updateList();
		});
	</script>

	<style>
		.active {
			background-color: var(--text);
			color: var(--bg);
		}
		.filter-button:hover {
			background-color: var(--surface);
		}
	</style>
</Layout>
