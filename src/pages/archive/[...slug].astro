---
import RelatedPosts from "@/components/RelatedPosts.astro"
import BookmarkToggle from "@/components/svelte/BookmarkToggle.svelte"
import Layout from "@/layouts/Layout.astro"
import { Icon } from "astro-icon/components"
import { getCollection, render } from "astro:content"

const archive = await getCollection("archive")
export async function getStaticPaths() {
	const posts = await getCollection("archive")
	return posts.map(post => ({
		params: { slug: post.id },
		props: post,
	}))
}
const post = Astro.props
const canonicalURL = new URL(`/archive/${post.id}/`, Astro.site)
const encodedURL = encodeURIComponent(canonicalURL.href)
const encodedTitle = encodeURIComponent(post.data.title)
const encodedText = encodeURIComponent(
	`${post.data.title}${post.data.description ? ` — ${post.data.description}` : ""}`,
)
const shareLinks = [
	{
		label: "Telegram",
		icon: "mdi:telegram",
		href: `https://t.me/share/url?url=${encodedURL}&text=${encodedText}`,
	},
	{
		label: "VK",
		icon: "mdi:vk",
		href: `https://vk.com/share.php?url=${encodedURL}&title=${encodedTitle}`,
	},
	{
		label: "X",
		icon: "mdi:twitter",
		href: `https://twitter.com/intent/tweet?url=${encodedURL}&text=${encodedText}`,
	},
	{
		label: "WhatsApp",
		icon: "mdi:whatsapp",
		href: `https://api.whatsapp.com/send?text=${encodedText}%20${encodedURL}`,
	},
]
const articleSchema = {
	"@context": "https://schema.org",
	"@type": "Article",
	headline: post.data.title,
	description: post.data.description,
	datePublished: post.data.pubDate,
	author: (post.data.author || ["UnitOne"]).map((name) => ({
		"@type": "Person",
		name,
	})),
	mainEntityOfPage: canonicalURL.href,
}
const { Content } = await render(post)
---

	<Layout {...post.data} type ogImage={post.data.ogImage?.src} hidePageHeader>
		<main class="my-prose">
			<article data-iv-article class="md:grid md:grid-cols-[auto_1fr] md:gap-6">
				<section
					class="mb-6 rounded-2xl border border-[color:var(--border)] bg-[color:var(--surface)]/90 p-4 md:sticky md:top-24 md:mb-0 md:h-fit md:p-2"
				>
					<div class="flex flex-wrap items-center gap-2 md:flex-col md:justify-center">
						<p class="mr-2 text-xs font-semibold uppercase tracking-wide text-[color:var(--muted)]">
							Поделиться
						</p>
						{
							shareLinks.map((share) => (
								<a
									href={share.href}
									target="_blank"
									rel="noopener noreferrer"
									aria-label={`Поделиться в ${share.label}`}
									title={`Поделиться в ${share.label}`}
									class="inline-flex h-9 w-9 items-center justify-center rounded-full bg-black text-white transition hover:opacity-85"
								>
									<Icon name={share.icon} class="h-4 w-4" />
								</a>
							))
						}
						<button
							id="share-copy"
							type="button"
							data-share-url={canonicalURL.href}
							aria-label="Копировать ссылку"
							title="Копировать ссылку"
							class="inline-flex h-9 w-9 items-center justify-center rounded-full bg-black text-white transition hover:opacity-85"
						>
								<Icon name="mdi:content-copy" class="h-4 w-4" />
							</button>
						<span id="share-copy-status" class="text-xs text-[color:var(--muted)]" aria-live="polite"></span>
					</div>
				</section>
				<div>
				<header class="mb-8">
					<h1 data-iv-title class="mb-3 text-4xl font-black tracking-tight md:text-5xl">
						{post.data.title}
					</h1>
				{
					post.data.pubDate && (
						<time data-iv-date datetime={post.data.pubDate} class="text-sm text-[color:var(--muted)]">
							{new Date(post.data.pubDate).toLocaleDateString("ru-RU", {
								year: "numeric",
								month: "numeric",
								day: "numeric",
							})}
						</time>
					)
				}
					<div class="mt-4 flex flex-wrap items-center gap-2">
						<BookmarkToggle
							client:load
						id={post.id}
						title={post.data.title}
						description={post.data.description || ""}
						date={String(post.data.pubDate || "")}
							href={`/archive/${post.id}/`}
							variant="article"
						/>
					</div>
				</header>
				<Content />
				</div>
			</article>
		</main>
	<RelatedPosts posts={archive} href="/archive" />

	<script is:inline type="application/ld+json" set:html={JSON.stringify(articleSchema)} />

	<script is:inline>
		(() => {
			const shareCopyBtn = document.getElementById("share-copy")
			const shareCopyStatus = document.getElementById("share-copy-status")

			shareCopyBtn?.addEventListener("click", async () => {
				const shareURL = shareCopyBtn.getAttribute("data-share-url") || window.location.href
				try {
					if (navigator.clipboard?.writeText) {
						await navigator.clipboard.writeText(shareURL)
					} else {
						const fallbackInput = document.createElement("input")
						fallbackInput.value = shareURL
						document.body.appendChild(fallbackInput)
						fallbackInput.select()
						document.execCommand("copy")
						document.body.removeChild(fallbackInput)
					}
					if (shareCopyStatus) shareCopyStatus.textContent = "Ссылка скопирована"
					setTimeout(() => {
						if (shareCopyStatus) shareCopyStatus.textContent = ""
					}, 2000)
				} catch {
					if (shareCopyStatus) shareCopyStatus.textContent = "Не удалось скопировать"
				}
			})
		})()
	</script>
</Layout>
