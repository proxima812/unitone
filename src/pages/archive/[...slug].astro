---
import Layout from "@/layouts/Layout.astro";
import { getPublishedArticleBySlug } from "@/lib/db/articles";
import { enhanceArticleLinksHtml } from "@/lib/content/sanitize";

export const prerender = false;

const rawSlug = Astro.params.slug || "";
const slug = rawSlug.replace(/^\/+|\/+$/g, "").split("/")[0];
const post = slug ? await getPublishedArticleBySlug(slug) : null;

if (!post) {
  return Astro.redirect("/404");
}

const canonicalURL = new URL(`/archive/${post.slug}/`, Astro.site);
const encodedURL = encodeURIComponent(canonicalURL.href);
const encodedTitle = encodeURIComponent(post.title);
const encodedText = encodeURIComponent(`${post.title}${post.description ? ` — ${post.description}` : ""}`);
const safeHtml = enhanceArticleLinksHtml(post.content_html, Astro.site?.toString());

const readingWords = post.content_html.replace(/<[^>]+>/g, " ").match(/[\p{L}\p{N}]+/gu) || [];
const readingMinutes = Math.max(1, Math.ceil(readingWords.length / 180));

const shareLinks = [
  {
    label: "Telegram",
    href: `https://t.me/share/url?url=${encodedURL}&text=${encodedText}`,
  },
  {
    label: "VK",
    href: `https://vk.com/share.php?url=${encodedURL}&title=${encodedTitle}`,
  },
  {
    label: "X",
    href: `https://twitter.com/intent/tweet?url=${encodedURL}&text=${encodedText}`,
  },
  {
    label: "WhatsApp",
    href: `https://api.whatsapp.com/send?text=${encodedText}%20${encodedURL}`,
  },
];
---

<Layout
  title={post.title}
  description={post.description || ""}
  datePublished={post.published_at || undefined}
  hidePageHeader
  breadcrumbCurrentLabel={post.title}
>
  <main class="mx-auto w-full max-w-6xl">
    <article class="grid grid-cols-1 gap-6 lg:grid-cols-[220px_minmax(0,1fr)] lg:gap-8">
      <aside class="hidden lg:block lg:sticky lg:top-28 lg:h-fit">
        <div class="space-y-4">
          <section class="rounded-2xl border border-[color:var(--border)] bg-[color:var(--surface)] p-4">
            <p class="text-xs uppercase tracking-wide text-[color:var(--muted)]">Автор</p>
            <p class="mt-2 text-sm font-medium text-[color:var(--text)]">{post.author_name || "Unity One"}</p>
          </section>

          <section class="rounded-2xl border border-[color:var(--border)] bg-[color:var(--surface)] p-4">
            <p class="text-xs uppercase tracking-wide text-[color:var(--muted)]">Поделиться</p>
            <div class="mt-3 flex flex-wrap gap-2">
              {shareLinks.map((share) => (
                <a
                  href={share.href}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="rounded-full border border-[color:var(--border)] px-3 py-1 text-xs"
                >
                  {share.label}
                </a>
              ))}
            </div>
          </section>
        </div>
      </aside>

      <div class="min-w-0">
        <header class="rounded-2xl border border-[color:var(--border)] bg-[color:var(--surface)] p-4 md:p-7">
          <div class="mb-4 flex flex-wrap items-center gap-3 text-sm text-[color:var(--muted)]">
            {post.published_at && (
              <time datetime={post.published_at}>
                {new Date(post.published_at).toLocaleDateString("ru-RU", {
                  year: "numeric",
                  month: "long",
                  day: "numeric",
                })}
              </time>
            )}
            <span class="rounded-full border border-[color:var(--border)] px-2 py-1">{readingMinutes} мин чтения</span>
          </div>

          <h1 class="text-4xl font-black leading-tight tracking-tight md:text-5xl">{post.title}</h1>
          {post.description && <p class="mt-3 text-[color:var(--muted)]">{post.description}</p>}
        </header>

        <section class="my-prose article-rich-content !mx-0 !mt-5 !max-w-none !p-5 md:!p-8" set:html={safeHtml} />
      </div>
    </article>
  </main>
</Layout>
