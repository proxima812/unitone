---
import RelatedPosts from "@/components/RelatedPosts.astro"
import MorePostsByAuthor from "@/components/MorePostsByAuthor.astro"
import BookmarkToggle from "@/components/svelte/BookmarkToggle.svelte"
import Layout from "@/layouts/Layout.astro"
import { Icon } from "astro-icon/components"
import { getCollection, render } from "astro:content"

const archive = await getCollection("archive")
export async function getStaticPaths() {
	const posts = await getCollection("archive")
	return posts.map(post => ({
		params: { slug: post.id },
		props: post,
	}))
}
const post = Astro.props
const canonicalURL = new URL(`/archive/${post.id}/`, Astro.site)
const encodedURL = encodeURIComponent(canonicalURL.href)
const encodedTitle = encodeURIComponent(post.data.title)
const encodedText = encodeURIComponent(
	`${post.data.title}${post.data.description ? ` — ${post.data.description}` : ""}`,
)
const currentAuthor = post.data.author?.[0] || ""
const currentTags = post.data.tags || []
const archiveById = new Map(archive.map((item) => [item.id, item]))
const normalizeArchiveId = (value: string) =>
	value.trim().replace(/^\/+|\/+$/g, "").replace(/^archive\//, "")
const manualRelatedIds = Array.isArray(post.data.relatedPosts)
	? post.data.relatedPosts.map(normalizeArchiveId).filter(Boolean)
	: []
const manualRelatedPosts = manualRelatedIds
	.map((id) => archiveById.get(id))
	.filter((item) => item && item.id !== post.id)

function detectStepNumber(title?: string, tags: string[] = []) {
	const sources = [title || "", ...tags]
	for (const source of sources) {
		const match = source.match(/шаг\s*(\d{1,2})/i)
		if (match) return Number(match[1])
	}
	return null
}

function dateValue(v?: string | Date) {
	if (!v) return 0
	return new Date(v).getTime() || 0
}

const currentStep = detectStepNumber(post.data.title, currentTags)
const nextStepPost =
	currentStep && currentStep < 12
		? archive
				.filter((item) => item.id !== post.id)
				.map((item) => ({
					item,
					step: detectStepNumber(item.data.title, item.data.tags || []),
					date: dateValue(item.data.pubDate),
				}))
				.filter((x) => x.step === currentStep + 1)
				.sort((a, b) => b.date - a.date)[0]?.item
		: null

const shareLinks = [
	{
		label: "Telegram",
		icon: "mdi:telegram",
		href: `https://t.me/share/url?url=${encodedURL}&text=${encodedText}`,
	},
	{
		label: "VK",
		icon: "mdi:vk",
		href: `https://vk.com/share.php?url=${encodedURL}&title=${encodedTitle}`,
	},
	{
		label: "X",
		icon: "mdi:twitter",
		href: `https://twitter.com/intent/tweet?url=${encodedURL}&text=${encodedText}`,
	},
	{
		label: "WhatsApp",
		icon: "mdi:whatsapp",
		href: `https://api.whatsapp.com/send?text=${encodedText}%20${encodedURL}`,
	},
]
const articleSchema = {
	"@context": "https://schema.org",
	"@type": "Article",
	headline: post.data.title,
	description: post.data.description,
	datePublished: post.data.pubDate,
	author: (post.data.author || ["UnitOne"]).map((name) => ({
		"@type": "Person",
		name,
	})),
	mainEntityOfPage: canonicalURL.href,
}
const { Content } = await render(post)
---

	<Layout
		{...post.data}
		type
		ogImage={post.data.ogImage?.src}
		hidePageHeader
		breadcrumbCurrentLabel={post.data.title}
	>
		<main class="my-prose">
			<article data-iv-article class="md:grid md:grid-cols-[auto_1fr] md:gap-6">
				<section
					class="mb-6 rounded-2xl border border-[color:var(--border)] bg-[color:var(--surface)]/90 p-4 md:sticky md:top-24 md:mb-0 md:h-fit md:p-2"
				>
					<div class="flex flex-wrap items-center gap-2 md:flex-col md:justify-center">

						{
							shareLinks.map((share) => (
								<a
									href={share.href}
									target="_blank"
									rel="noopener noreferrer"
									aria-label={`Поделиться в ${share.label}`}
									title={`Поделиться в ${share.label}`}
									class="inline-flex h-9 w-9 items-center justify-center rounded-full bg-black text-white transition hover:opacity-85"
								>
									<Icon name={share.icon} class="h-4 w-4" />
								</a>
							))
						}
						<button
							id="share-copy"
							type="button"
							data-share-url={canonicalURL.href}
							aria-label="Копировать ссылку"
							title="Копировать ссылку"
							class="inline-flex h-9 w-9 items-center justify-center rounded-full bg-black text-white transition hover:opacity-85"
						>
								<Icon name="mdi:content-copy" class="h-4 w-4" />
							</button>
					</div>
				</section>
				<div>
				<header class="mb-8">
					<h1 data-iv-title class="mb-3 text-4xl font-black tracking-tight md:text-5xl">
						{post.data.title}
					</h1>
				{
					post.data.pubDate && (
						<time data-iv-date datetime={post.data.pubDate} class="text-sm text-[color:var(--muted)]">
							{new Date(post.data.pubDate).toLocaleDateString("ru-RU", {
								year: "numeric",
								month: "numeric",
								day: "numeric",
							})}
						</time>
					)
				}
					<div class="mt-4 flex flex-wrap items-center gap-2">
						<BookmarkToggle
							client:load
						id={post.id}
						title={post.data.title}
						description={post.data.description || ""}
						date={String(post.data.pubDate || "")}
							href={`/archive/${post.id}/`}
							variant="article"
						/>
					</div>
				</header>
				<Content />
				{
					manualRelatedPosts.length > 0 && (
						<section class="mt-10 rounded-2xl border border-[color:var(--border)] bg-[color:var(--surface)] p-5">
							<h2 class="text-2xl font-semibold">Что еще почитать по этой теме</h2>
							<p class="mt-2 text-sm text-[color:var(--muted)]">
								Автор рекомендует эти материалы как смысловое продолжение.
							</p>
							<div class="mt-4 grid grid-cols-1 gap-4 md:grid-cols-2">
								{manualRelatedPosts.map((item) => (
									<a
										href={`/archive/${item.id}/`}
										class="group rounded-xl border border-[color:var(--border)] bg-[color:var(--surface)] p-4 transition hover:shadow-sm hover:shadow-black/10"
									>
										<h3 class="line-clamp-2 text-lg font-semibold leading-tight group-hover:opacity-85">
											{item.data.title}
										</h3>
										<p class="mt-2 line-clamp-3 text-sm text-[color:var(--muted)]">
											{item.data.description}
										</p>
									</a>
								))}
							</div>
						</section>
					)
				}
				{
					currentStep && (
						<section class="mt-10 rounded-2xl border border-[color:var(--border)] bg-[color:var(--surface)] p-5">
							<h2 class="text-2xl font-semibold">Дальше по шагам</h2>
							<p class="mt-2 text-[color:var(--muted)]">
								Если этот текст откликнулся, продолжайте путь последовательно. Пройдите шаги дальше и
								дойдите до 12 шага, чтобы увидеть полную картину изменений.
							</p>
							<div class="mt-4 flex flex-wrap gap-3">
								{nextStepPost && (
									<a
										href={`/archive/${nextStepPost.id}/`}
										class="inline-flex items-center rounded-full bg-[color:var(--text)] px-4 py-2 text-sm text-[color:var(--bg)] transition hover:opacity-85"
									>
										Читать шаг {currentStep + 1}
									</a>
								)}
								<a
									href="/archive"
									class="inline-flex items-center rounded-full border border-[color:var(--border)] px-4 py-2 text-sm text-[color:var(--muted)] transition hover:opacity-75"
								>
									Все материалы по шагам
								</a>
							</div>
						</section>
					)
				}
				<div class="mt-8 rounded-xl border border-[color:var(--border)] bg-[color:var(--surface)] p-4 text-sm leading-relaxed text-[color:var(--muted)]">
					Этот материал отражает личный опыт и мнение автора. Он не является руководством к действию,
					не навязывает подход и не заменяет профессиональную помощь.
				</div>
				</div>
			</article>
		</main>
	<MorePostsByAuthor
		posts={archive}
		href="/archive"
		currentId={post.id}
		author={currentAuthor}
		currentTags={currentTags}
		limit={2}
	/>
	<RelatedPosts
		posts={archive}
		href="/archive"
		currentId={post.id}
		currentTags={currentTags}
		currentAuthor={currentAuthor}
		currentTitle={post.data.title}
		limit={3}
	/>

	<script is:inline type="application/ld+json" set:html={JSON.stringify(articleSchema)} />

	<script is:inline>
		(() => {
			const shareCopyBtn = document.getElementById("share-copy")
			let copyFeedbackTimer

			shareCopyBtn?.addEventListener("click", async () => {
				const shareURL = shareCopyBtn.getAttribute("data-share-url") || window.location.href
				try {
					if (navigator.clipboard?.writeText) {
						await navigator.clipboard.writeText(shareURL)
					} else {
						const fallbackInput = document.createElement("input")
						fallbackInput.value = shareURL
						document.body.appendChild(fallbackInput)
						fallbackInput.select()
						document.execCommand("copy")
						document.body.removeChild(fallbackInput)
					}
					shareCopyBtn.classList.remove("bg-black")
					shareCopyBtn.classList.add("bg-green-600")
					clearTimeout(copyFeedbackTimer)
					copyFeedbackTimer = setTimeout(() => {
						shareCopyBtn.classList.remove("bg-green-600")
						shareCopyBtn.classList.add("bg-black")
					}, 2000)
				} catch {
					shareCopyBtn.classList.remove("bg-green-600")
					shareCopyBtn.classList.add("bg-black")
				}
			})
		})()
	</script>
</Layout>
