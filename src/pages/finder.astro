---
import { communities } from "@/data/communities"
import Layout from "@/layouts/Layout.astro"
import { Icon } from "astro-icon/components"

const filterDefinitions = [
	{ id: "alcohol", label: "üç∑ –ê–ª–∫–æ–≥–æ–ª—å", hint: "–ì—Ä—É–ø–ø—ã –ø–æ –∞–ª–∫–æ–≥–æ–ª—é" },
	{ id: "drugs", label: "üíä –ù–∞—Ä–∫–æ—Ç–∏–∫–∏", hint: "–ü–ê–í –∏ —Ö–∏–º–∏—á–µ—Å–∫–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏" },
	{ id: "nicotine", label: "üö≠ –ù–∏–∫–æ—Ç–∏–Ω", hint: "–ö—É—Ä–µ–Ω–∏–µ –∏ –Ω–∏–∫–æ—Ç–∏–Ω" },
	{ id: "food", label: "üçΩÔ∏è –ü–∏—â–µ–≤–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ", hint: "–ü–µ—Ä–µ–µ–¥–∞–Ω–∏–µ –∏ –†–ü–ü" },
	{ id: "gambling", label: "üé∞ –ò–≥—Ä—ã –∏ —Å—Ç–∞–≤–∫–∏", hint: "–ê–∑–∞—Ä—Ç–Ω—ã–µ –∏–≥—Ä—ã" },
	{ id: "sex_love", label: "‚ù§Ô∏è –°–µ–∫—Å –∏ –æ—Ç–Ω–æ—à–µ–Ω–∏—è", hint: "–õ—é–±–æ–≤–Ω–∞—è/—Å–µ–∫—Å—É–∞–ª—å–Ω–∞—è –∫–æ–º–ø—É–ª—å—Å–∏–≤–Ω–æ—Å—Ç—å" },
	{ id: "digital", label: "üì± –ò–Ω—Ç–µ—Ä–Ω–µ—Ç –∏ –º–µ–¥–∏–∞", hint: "–î–∏–¥–∂–∏—Ç–∞–ª-–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏" },
	{ id: "mind", label: "üß† –ü—Å–∏—Ö–∏–∫–∞ –∏ —ç–º–æ—Ü–∏–∏", hint: "–≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –∏ –ø—Å–∏—Ö–∏—á–µ—Å–∫–∏–µ —Ç—Ä—É–¥–Ω–æ—Å—Ç–∏" },
	{ id: "family", label: "üë™ –î–ª—è –±–ª–∏–∑–∫–∏—Ö", hint: "–†–æ–¥–Ω—ã–µ –∏ —Å–µ–º—å–∏ –∑–∞–≤–∏—Å–∏–º—ã—Ö" },
	{ id: "finance", label: "üí∞ –î–µ–Ω—å–≥–∏ –∏ –¥–æ–ª–≥–∏", hint: "–î–æ–ª–≥–∏, —Ä–∞–±–æ—Ç–∞, –∑–∞—Ä–∞–±–æ—Ç–æ–∫" },
	{ id: "social", label: "üåç –°–æ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏", hint: "–°–æ—Ü–∏–∞–ª—å–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞" },
	{ id: "creative", label: "üé® –¢–≤–æ—Ä—á–µ—Å–∫–∏–µ –≥—Ä—É–ø–ø—ã", hint: "–¢–≤–æ—Ä—á–µ—Å–∫–∏–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è" },
	{ id: "spiritual", label: "üïäÔ∏è –°–≤–µ—Ç—Å–∫–∏–µ –∏ –¥—É—Ö–æ–≤–Ω—ã–µ", hint: "–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –º–æ–¥–µ–ª–∏ –≤—ã–∑–¥–æ—Ä–æ–≤–ª–µ–Ω–∏—è" },
	{ id: "general", label: "‚ôª –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ", hint: "–û–±—â–∏–µ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞" },
]

function includesAny(text: string, words: string[]) {
	return words.some((word) => text.includes(word))
}

function buildFacets(item: (typeof communities)[number]) {
	const text = `${item.title} ${item.description} ${item.category}`.toLowerCase()
	const facets = new Set<string>()

	if (includesAny(text, ["–∞–ª–∫–æ–≥–æ–ª", "–∞–∞ "])) facets.add("alcohol")
	if (includesAny(text, ["–Ω–∞—Ä–∫–æ–º", "—Ö–∏–º–∏—á–µ—Å–∫", "–º–µ—Ç–∞–º—Ñ–µ—Ç", "–∫–æ–∫–∞–∏–Ω", "–≥–µ—Ä–æ–∏–Ω", "—Ç–∞–±–ª–µ—Ç"])) facets.add("drugs")
	if (includesAny(text, ["–Ω–∏–∫–æ—Ç–∏–Ω", "–∫—É—Ä"])) facets.add("nicotine")
	if (includesAny(text, ["–ø–∏—â", "–ø–µ—Ä–µ–µ–¥–∞", "—Ä–ø–ø", "–æ–±–∂–æ—Ä"])) facets.add("food")
	if (includesAny(text, ["–∏–≥—Ä–æ–∫", "–∏–≥—Ä", "—Å—Ç–∞–≤–∫"])) facets.add("gambling")
	if (includesAny(text, ["—Å–µ–∫—Å", "–ª—é–±–æ–≤", "–æ—Ç–Ω–æ—à–µ–Ω"])) facets.add("sex_love")
	if (includesAny(text, ["–∏–Ω—Ç–µ—Ä–Ω–µ—Ç", "–º–µ–¥–∏–∞", "–ø—Ä–æ–∫—Ä–∞—Å—Ç", "–∫–æ–º–ø—å—é—Ç–µ—Ä"])) facets.add("digital")
	if (includesAny(text, ["–ø—Å–∏—Ö", "—ç–º–æ—Ü", "—à–∏–∑–æ", "—Ç—Ä–∏—Ö–æ—Ç", "–¥–µ–ø—Ä–µ—Å—Å", "–Ω–µ–≤—Ä–æ—Ç", "–¥–µ–π–¥—Ä–∏–º–µ—Ä"])) facets.add("mind")
	if (includesAny(text, ["—Å–µ–º—å", "—Ä–æ–¥–∏—Ç–µ–ª", "–±–ª–∏–∑–∫", "–∞–ª-–∞–Ω–æ–Ω", "–∞–ª–∞—Ç–∏–Ω", "–∏-–∞–Ω–æ–Ω", "–Ω–∞—Ä-–∞–Ω–æ–Ω"])) facets.add("family")
	if (includesAny(text, ["–¥–æ–ª–≥", "—Ñ–∏–Ω–∞–Ω—Å", "–±–µ–∑—Ä–∞–±–æ—Ç", "–±–∏–∑–Ω–µ—Å", "–∑–∞—Ä–∞–±–∞—Ç", "—Ç—Ä—É–¥–æ–≥–æ–ª"])) facets.add("finance")
	if (includesAny(text, ["—Å–æ—Ü–∏–∞–ª—å", "–Ω–∞—Å–∏–ª–∏", "—Ä–µ–ª–∏–≥", "—ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü", "—Ç—Ä–∞—Ñ–∏–∫–∏–Ω–≥"])) facets.add("social")
	if (includesAny(text, ["—Ö—É–¥–æ–∂", "—Ç–≤–æ—Ä—á"])) facets.add("creative")
	if (includesAny(text, ["smart", "refuge", "lifering", "—Å–≤–µ—Ç—Å–∫", "–±—É–¥–¥–∏–π", "–æ–∫—Å—Ñ–æ—Ä–¥"])) facets.add("spiritual")
	if (includesAny(text, ["–æ–±—â–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏", "–∞–Ω–æ–Ω–∏–º–Ω—ã–µ –≤—ã–∑–¥–æ—Ä–∞–≤–ª–∏–≤–∞—é—â–∏–µ", "—É–Ω–∏–≤–µ—Ä—Å"])) facets.add("general")

	if (item.category === "‚ôª –û–±—â–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏") facets.add("general")
	if (item.category === "üß† –ü—Å–∏—Ö–∏—á–µ—Å–∫–∏–µ —Ä–∞—Å—Å—Ç—Ä–æ–π—Å—Ç–≤–∞") facets.add("mind")
	if (item.category === "üë™ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –¥–ª—è –±–ª–∏–∑–∫–∏—Ö") facets.add("family")
	if (item.category === "üí∞ –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Ç—Ä—É–¥–Ω–æ—Å—Ç–∏") facets.add("finance")
	if (item.category === "üçΩÔ∏è –ü—Ä–æ–±–ª–µ–º—ã —Å –ø–∏—â–µ–π") facets.add("food")
	if (item.category === "üåç –°–æ—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã") facets.add("social")
	if (item.category === "üé® –¢–≤–æ—Ä—á–µ—Å–∫–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏") facets.add("creative")
	if (item.category === "üíä –ù–∞—Ä–∫–æ—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏") facets.add("drugs")
	if (item.category === "üç∑ –ê–ª–∫–æ–≥–æ–ª—å–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏") facets.add("alcohol")
	if (item.category === "üîñ –î—Ä—É–≥–æ–µ") facets.add("spiritual")

	if (facets.size === 0) facets.add("general")
	return [...facets]
}

const prepared = communities.map((item) => ({
	...item,
	facets: buildFacets(item),
	searchText: `${item.title} ${item.description} ${item.category}`.toLowerCase(),
}))

const availableFilters = filterDefinitions
	.map((filter) => ({
		...filter,
		count: prepared.filter((item) => item.facets.includes(filter.id)).length,
	}))
	.filter((filter) => filter.count > 0)
---

<Layout
	title="–ü–æ–¥–±–æ—Ä –≥—Ä—É–ø–ø—ã"
	description={`–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥—Ö–æ–¥—è—â–µ–µ —Å–æ–æ–±—â–µ—Å—Ç–≤–æ –∏–∑ ${communities.length} –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤: –ø–æ —Ç–µ–º–µ, —Ñ–æ—Ä–º–∞—Ç—É –∑–∞–ø—Ä–æ—Å–∞ –∏ –∂–∏–∑–Ω–µ–Ω–Ω–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏.`}
>
	<section class="rounded-2xl border border-[color:var(--border)] bg-[color:var(--surface)] p-5 md:p-6">
		<h2 class="text-2xl font-bold text-[color:var(--text)] md:text-3xl">–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –ø–æ–¥–±–æ—Ä–æ–º</h2>
		<p class="mt-2 text-[color:var(--muted)]">
			–í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –¥–µ—Ç–∞–ª—å–Ω—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é. –ö–∞—Ä—Ç–æ—á–∫–∏ –Ω–∏–∂–µ —Å—Ä–∞–∑—É –æ—Ç—Ñ–∏–ª—å—Ç—Ä—É—é—Ç—Å—è,
			—á—Ç–æ–±—ã –≤—ã –±—ã—Å—Ç—Ä–µ–µ –Ω–∞—à–ª–∏ –ø–æ–¥—Ö–æ–¥—è—â—É—é –≥—Ä—É–ø–ø—É.
		</p>

		<div class="mt-4 grid grid-cols-1 gap-3 md:grid-cols-[1fr_auto]">
			<input
				id="finder-search"
				type="search"
				placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –¥–æ–ª–≥–∏, –Ω–∏–∫–æ—Ç–∏–Ω, —Å–µ–º—å—è, —Ç—Ä–µ–≤–æ–≥–∞, –∏–Ω—Ç–µ—Ä–Ω–µ—Ç..."
				aria-label="–ü–æ–∏—Å–∫ –ø–æ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞–º"
				class="w-full rounded-xl border border-[color:var(--border)] bg-[color:var(--surface)] px-4 py-2.5 text-sm text-[color:var(--text)]"
			/>
			<button
				id="finder-reset"
				type="button"
				class="rounded-xl border border-[color:var(--border)] bg-[color:var(--surface)] px-4 py-2.5 text-sm text-black"
			>
				–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
			</button>
		</div>

		<div id="finder-filters" class="mt-4 flex flex-wrap gap-2">
			<button
				type="button"
				data-filter="all"
				data-active="true"
				class="finder-filter rounded-full border border-[color:var(--border)] bg-[color:var(--text)] px-3 py-1.5 text-sm text-[color:var(--bg)]"
			>
				–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ({prepared.length})
			</button>
			{
				availableFilters.map((filter) => (
					<button
						type="button"
						data-filter={filter.id}
						data-active="false"
						title={filter.hint}
						class="finder-filter rounded-full border border-[color:var(--border)] bg-[color:var(--surface)] px-3 py-1.5 text-sm text-[color:var(--text)]"
					>
						{filter.label} ({filter.count})
					</button>
				))
			}
		</div>
		<p class="mt-3 text-sm text-[color:var(--muted)]">
			–ù–∞–π–¥–µ–Ω–æ —Å–æ–æ–±—â–µ—Å—Ç–≤: <span id="finder-count" class="font-semibold text-[color:var(--text)]">{prepared.length}</span>
		</p>
	</section>

	<section id="community-list" class="mt-6 grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-3">
		{
			prepared.map((item) => (
				<article
					data-facets={item.facets.join(",")}
					data-search={item.searchText}
					class="flex h-full flex-col rounded-2xl border border-[color:var(--border)] bg-[color:var(--surface)]"
				>
					<div class="p-5">
						<div class="mb-2 flex flex-wrap gap-2">
							<span class="rounded-full border border-[color:var(--border)] bg-[color:var(--bg)] px-2 py-1 text-xs text-[color:var(--muted)]">
								{item.category}
							</span>
							{
								item.facets.slice(0, 2).map((facetId) => {
									const facet = availableFilters.find((x) => x.id === facetId)
									return facet ? (
										<span class="rounded-full border border-[color:var(--border)] px-2 py-1 text-xs text-[color:var(--muted)]">
											{facet.label}
										</span>
									) : null
								})
							}
						</div>
						<h3 class="text-lg font-semibold leading-tight text-[color:var(--text)]">{item.title}</h3>
						<p class="mt-2 line-clamp-3 text-sm text-[color:var(--muted)]">{item.description}</p>
					</div>

					<div class="mt-auto border-t border-[color:var(--border)] p-4">
						<div class="mb-3 flex items-center justify-between text-sm">
							<span>
								–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:{" "}
								<b class={item.find ? "text-emerald-600" : "text-red-600"}>{item.find ? "–ï—Å—Ç—å" : "–ù–µ—Ç"}</b>
							</span>
							<span>
								–û—Å–Ω–æ–≤–∞–Ω:{" "}
								<b class={item.since ? "text-emerald-600" : "text-red-600"}>{item.since || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"}</b>
							</span>
						</div>

						<div class="flex gap-2 md:flex-nowrap flex-wrap justify-between">
							<a
								href={item.tg_group_link_topic}
								aria-label={item.title}
								target="_blank"
								class="md:w-auto w-full inline-flex items-center justify-center gap-1 rounded-lg bg-[#229ED9] px-3 py-2 text-sm font-medium text-white transition hover:bg-[#1D8FC3]"
							>
								<Icon name="solar:plain-2-bold-duotone" />
								<span>–û—Ç–∫—Ä—ã—Ç—å –≤ Telegram</span>
							</a>
							{
								item.wikipedia ? (
									<a
										href={item.wikipedia}
										aria-label={item.title}
										target="_blank"
										class="md:w-auto w-full inline-flex items-center justify-center gap-1 rounded-lg border border-[#A2A9B1] bg-[#F8F9FA] px-3 py-2 text-sm font-medium text-[#202122] transition hover:bg-[#EAECF0]"
									>
										<Icon name="solar:book-2-bold-duotone" />
										<span>Wikipedia</span>
									</a>
								) : (
									<span class="md:w-auto w-full inline-flex items-center justify-center rounded-lg border border-[color:var(--border)] bg-[color:var(--bg)] px-3 py-2 text-sm text-[color:var(--muted)]">
										Wikipedia –Ω–µ—Ç
									</span>
								)
							}
						</div>
					</div>
				</article>
			))
		}
	</section>

	<div id="finder-empty" class="mt-6 hidden rounded-xl border border-[color:var(--border)] bg-[color:var(--surface)] p-4 text-center text-[color:var(--muted)]">
		–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —É–±—Ä–∞—Ç—å —Ñ–∏–ª—å—Ç—Ä –∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å.
	</div>

	<script>
		document.addEventListener("DOMContentLoaded", () => {
			const filters = document.querySelectorAll(".finder-filter")
			const cards = document.querySelectorAll("#community-list article")
			const searchInput = document.getElementById("finder-search")
			const resetButton = document.getElementById("finder-reset")
			const counter = document.getElementById("finder-count")
			const emptyState = document.getElementById("finder-empty")

			let activeFilter = "all"

			const applyFilters = () => {
				const query = (searchInput?.value || "").toLowerCase().trim()
				let visibleCount = 0

				cards.forEach((card) => {
					const facets = (card.dataset.facets || "").split(",").map((x) => x.trim())
					const searchable = card.dataset.search || ""
					const categoryMatch = activeFilter === "all" || facets.includes(activeFilter)
					const queryMatch = !query || searchable.includes(query)
					const visible = categoryMatch && queryMatch
					card.classList.toggle("hidden", !visible)
					if (visible) visibleCount += 1
				})

				if (counter) counter.textContent = String(visibleCount)
				emptyState?.classList.toggle("hidden", visibleCount !== 0)
			}

			filters.forEach((button) => {
				button.addEventListener("click", () => {
					activeFilter = button.dataset.filter || "all"
					filters.forEach((btn) => {
						const active = (btn.dataset.filter || "all") === activeFilter
						btn.dataset.active = active ? "true" : "false"
						btn.classList.toggle("bg-[color:var(--text)]", active)
						btn.classList.toggle("text-[color:var(--bg)]", active)
						btn.classList.toggle("bg-[color:var(--surface)]", !active)
						btn.classList.toggle("text-[color:var(--text)]", !active)
					})
					applyFilters()
				})
			})

			searchInput?.addEventListener("input", applyFilters)

			resetButton?.addEventListener("click", () => {
				activeFilter = "all"
				if (searchInput) searchInput.value = ""
				filters.forEach((btn) => {
					const active = (btn.dataset.filter || "all") === "all"
					btn.dataset.active = active ? "true" : "false"
					btn.classList.toggle("bg-[color:var(--text)]", active)
					btn.classList.toggle("text-[color:var(--bg)]", active)
					btn.classList.toggle("bg-[color:var(--surface)]", !active)
					btn.classList.toggle("text-[color:var(--text)]", !active)
				})
				applyFilters()
			})

			applyFilters()
		})
	</script>
</Layout>
