---
import Container from "@/components/Container.astro";
import Breadcrumbs from "@/components/Breadcrumbs.astro";
import Footer from "@/components/Footer.astro";
import Header from "@/components/Header.astro";
import SEO from "@/components/SEO.astro";
import "@/styles/tailwind.css";

interface Props {
	title: string;
	description: string;
	keywords?: string;
	datePublished?: string;
	bodyStyle?: string;
	dateModified?: string;
	indexRobots?: string;
	type?: any;
	ogImage?: any;
	hidePageHeader?: boolean;
	breadcrumbCurrentLabel?: string;
}

const {
	datePublished,
	bodyStyle,
	dateModified,
	indexRobots,
	title,
	type,
	description,
	keywords,
	ogImage,
	hidePageHeader,
	breadcrumbCurrentLabel,
} = Astro.props;
---

<html lang="ru" class="scroll-smooth subpixel-antialiased">
	<head>
		<SEO
			title={title}
			description={description}
			keywords={keywords}
			indexRobots={indexRobots}
			ogImage={ogImage}
			type={type}
			datePublished={datePublished}
			dateModified={dateModified}
		/>
		<link rel="manifest" href="/manifest.webmanifest" />
		<meta name="theme-color" content="#4281e0" />
		<script is:inline>
			(() => {
				const key = "unitone_theme";
				let saved = null;
				try {
					saved = localStorage.getItem(key);
				} catch {}
				const systemDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
				const theme = saved === "dark" || saved === "light" ? saved : (systemDark ? "dark" : "light");
				document.documentElement.setAttribute("data-theme", theme);
				const meta = document.querySelector('meta[name="theme-color"]');
				if (meta) meta.setAttribute("content", theme === "dark" ? "#273244" : "#4281e0");
			})();
		</script>
	</head>
	<body
		class={`${bodyStyle || ""} flex min-h-screen flex-col bg-[color:var(--bg)] text-[color:var(--text)]`}
	>
		<div
			id="app-loader"
			class="fixed inset-0 z-[60] flex items-center justify-center bg-[color:var(--bg)]"
		>
			<div
				class="h-8 w-8 animate-spin rounded-full border-2 border-[color:var(--border)] border-t-[color:var(--accent)]"
			>
			</div>
		</div>
		<Header />
		<Container class="py-20">
			<div class="flex flex-col gap-12">
				<Breadcrumbs currentLabel={breadcrumbCurrentLabel} />
				{
					Astro.url.pathname === "/" ||
					new URL(Astro.url, Astro.site).pathname === "/" ||
					hidePageHeader ? null : (
						<section class="text-center">
							{title && (
								<h1 class="mb-3 text-5xl font-black tracking-tight md:text-6xl xl:text-7xl">
									{title}
								</h1>
							)}
							{description && (
								<p class="mx-auto max-w-xl text-base text-[color:var(--muted)] md:text-lg lg:text-xl">
									{description}
								</p>
							)}
						</section>
					)
				}
				<slot />
			</div>
		</Container>
		<Footer />
		<div
			id="pwa-install"
			class="fixed md:w-[560px] w-[340px] bottom-4 left-1/2 z-[60] hidden -translate-x-1/2 rounded-xl border border-[color:var(--border)] bg-[color:var(--surface)] px-4 py-3 shadow-lg"
		>
			<div class="space-y-2">
				<p class="text-sm font-medium text-[color:var(--text)]">
					<span>Установить приложение на устройство?</span>
				</p>
				<p class="text-sm text-[color:var(--muted)]">
					<span>Будет быстрее открываться и работать как отдельное приложение.</span>
				</p>
				<div class="flex gap-2">
					<button
						id="pwa-install-btn"
						class="rounded-full bg-[var(--sk-button-background)] px-3 py-1.5 text-sm text-white hover:bg-[var(--sk-button-background-hover)] active:bg-[var(--sk-button-background-active)]"
					>
						<span>Установить</span>
					</button>
					<button
						id="pwa-install-close"
						class="rounded-full border border-[color:var(--border)] px-3 py-1.5 text-sm hover:border-[color:var(--primary)] hover:text-[color:var(--primary)] active:opacity-80"
					>
						<span>Позже</span>
					</button>
				</div>
			</div>
		</div>
		<script is:inline>
			window.addEventListener("load", () => {
				const loader = document.getElementById("app-loader");
				if (loader) loader.style.display = "none";
			});

			if ("serviceWorker" in navigator) {
				window.addEventListener("load", () => {
					navigator.serviceWorker.register("/sw.js");
				});
			}

			let deferredPrompt = null;
			const installBanner = document.getElementById("pwa-install");
			const installBtn = document.getElementById("pwa-install-btn");
			const closeBtn = document.getElementById("pwa-install-close");
			const PWA_DISMISS_KEY = "pwaInstallDismissedAt";
			const PWA_REMIND_AFTER_MS = 3 * 24 * 60 * 60 * 1000;

			const canShowPwaBanner = () => {
				const dismissedAt = Number(localStorage.getItem(PWA_DISMISS_KEY) || 0);
				if (!dismissedAt) return true;
				return Date.now() - dismissedAt >= PWA_REMIND_AFTER_MS;
			};

			window.addEventListener("beforeinstallprompt", (e) => {
				e.preventDefault();
				deferredPrompt = e;
				if (installBanner && canShowPwaBanner()) installBanner.classList.remove("hidden");
			});

			installBtn?.addEventListener("click", async () => {
				if (!deferredPrompt) return;
				deferredPrompt.prompt();
				await deferredPrompt.userChoice;
				deferredPrompt = null;
				if (installBanner) installBanner.classList.add("hidden");
			});

			closeBtn?.addEventListener("click", () => {
				localStorage.setItem(PWA_DISMISS_KEY, String(Date.now()));
				if (installBanner) installBanner.classList.add("hidden");
			});
		</script>
	</body>
</html>
